name: Run cypress tests

on:
  # this workflow is only called by others, won't be executed on itself
  # as it uses the pre-built docker image that is produced in the upstream job
  workflow_call:
    secrets:
      ROBOT_HSLID_EMAIL:
        required: true
      ROBOT_HSLID_PASSWORD:
        required: true

jobs:
  run_cypress_tests:
    name: Run cypress e2e tests locally
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Extract metadata to env variables
        uses: HSLdevcom/jore4-tools/github-actions/extract-metadata@extract-metadata-v1

      - name: start e2e env
        uses: HSLdevcom/jore4-flux/github-actions/setup-e2e-environment@setup-e2e-environment-v1
        with:
          ui_version: $IMAGE_NAME:$COMMIT_ID

      - name: Make sure that the correct NodeJS version is used
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Setup caching for node_modules
        uses: actions/cache@v3
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: Install yarn dependencies && check that lockfile is up-to-date
        run: yarn --frozen-lockfile

      - name: Fix the missing cypress binary in case it did not get retrieved from cache
        run: yarn cypress install

      - name: Run cypress tests
        run: yarn test:e2e:skip-map

      - name: Upload test results as an artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v3
        with:
          name: reports
          path: |
            ${{ github.workspace }}/cypress/videos
            ${{ github.workspace }}/cypress/screenshots
