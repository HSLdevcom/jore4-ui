name: Run cypress tests

on:
  # this workflow is only called by others, won't be executed on itself
  # as it uses the pre-built docker image that is produced in the upstream job
  workflow_call:

jobs:
  run_cypress_tests:
    name: Run cypress e2e tests from docker
    runs-on: ubuntu-latest-4-cores
    env:
      CYPRESS_IMAGE_NAME: hsldevcom/jore4-cypress

    steps:
      - name: Collect Workflow Telemetry
        uses: runforesight/foresight-workflow-kit-action@v1
        if: always()
        with:
          api_key: ${{ secrets.FORESIGHT_GITHUB_ACTIONS }}

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract metadata to env variables
        uses: HSLdevcom/jore4-tools/github-actions/extract-metadata@extract-metadata-v1

      - name: Start e2e env
        uses: HSLdevcom/jore4-tools/github-actions/setup-e2e-environment@setup-e2e-environment-v1
        with:
          ui_version: '${{ env.IMAGE_NAME }}:${{ env.COMMIT_ID }}'
          cypress_version: '${{ env.CYPRESS_IMAGE_NAME }}:${{ env.COMMIT_ID }}'

      - name: Run e2e tests from github action
        uses: HSLdevcom/jore4-tools/github-actions/run-cypress-tests@run-cypress-tests-v1
        with:
          test-tags: ''
          threads: '3'

      - name: Foresight Test Results
        uses: runforesight/foresight-test-kit-action@v1
        if: always()
        with:
          # api_key is optional if you add on public repository
          api_key: ${{ secrets.FORESIGHT_GITHUB_ACTIONS }}
          # following 3 options are required if you want to use test monitoring features
          test_format: JUNIT
          test_framework: CYPRESS
          # path to your test reports e.g. ./results/foresight-test-*.xml
          test_path: ${{ github.workspace }}/cypress/reports/junit/jore4-e2e-*.xml
